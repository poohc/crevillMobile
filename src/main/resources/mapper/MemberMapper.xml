<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.crevill.member.MemberMapper">
	
	<select id="checkExistCellPhone" parameterType="kr.co.crevill.member.MemberDto" resultType="Integer">
        SELECT COUNT(*)
          FROM MEMBER_PARENT
         WHERE CELL_PHONE = #{parentCellPhone}
         <if test="cellPhone != null and cellPhone != ''">
           AND CELL_PHONE != #{cellPhone}
         </if>
    </select>
	
	<select id="selectMemberInfo" parameterType="kr.co.crevill.member.MemberDto" resultType="kr.co.crevill.member.MemberVo">
    	SELECT NAME,
               CELL_PHONE,
               EMAIL,
               REPLACE(ADDRESS,'|','') ADDRESS,
			   SUBSTRING_INDEX(ADDRESS, '|', 1) ROAD_ADDRESS,
			   CASE WHEN INSTR(ADDRESS,'|') > 0 THEN SUBSTRING_INDEX(ADDRESS, '|', -1)
			        ELSE '' END AS DETAIL_ADDRESS,
               QR_CODE,
               PASSWORD,
               STORE_ID,
               CASE WHEN MEMBER_PARENT.STORE_ID = 'MOBILE' THEN '모바일'
                    WHEN (SELECT COUNT(V.VOUCHER_NO) FROM VOUCHER V, VOUCHER_SALE VS, VOUCHER_USE_VIEW U WHERE V.TICKET_NAME != '1회권' AND VS.BUY_CELL_PHONE = MEMBER_PARENT.CELL_PHONE AND V.VOUCHER_NO = VS.VOUCHER_NO AND VS.VOUCHER_NO = U.VOUCHER_NO AND U.TIME_LEFT_HOUR <![CDATA[ > ]]> 0) = 0 THEN 'NV'   
                    ELSE '바우처' 
                    END AS MEMBER_TYPE,
               CASE WHEN MEMBER_PARENT.STORE_ID = 'MOBILE' THEN '모바일'
                    ELSE (SELECT STORE_NAME FROM STORE S WHERE MEMBER_PARENT.STORE_ID = S.STORE_ID) 
                    END AS STORE_NAME,
               CASE WHEN MEMBER_PARENT.STORE_ID = 'MOBILE' THEN '모바일'
                    ELSE (SELECT SUBSTRING_INDEX(S.STORE_NAME, ' ', - 1) FROM STORE S WHERE MEMBER_PARENT.STORE_ID = S.STORE_ID) 
                    END AS STORE_NAME_SHORT
    	  FROM MEMBER_PARENT
         WHERE CELL_PHONE = #{parentCellPhone} 
    </select>
	
	<select id="selectChildMemberInfo" parameterType="kr.co.crevill.member.MemberDto" resultType="kr.co.crevill.member.MemberVo">
        SELECT A.NAME,
               A.CELL_PHONE,
               A.EMAIL,
               A.ADDRESS,
               A.QR_CODE,
               B.NAME CHILD_NAME,
               B.BIRTHDAY,
               B.SEX,
               (SELECT GROUP_CONCAT(C.LEARNING_GRADE SEPARATOR ',') FROM MEMBER_CHILDREN_GRADE C WHERE C.PARENT_CELL_PHONE = A.CELL_PHONE AND C.CHILDREN_NAME = B.NAME) LEARNING_GRADE,
               A.STORE_ID,
               B.ENG_NAME
          FROM MEMBER_PARENT A,
               MEMBER_CHILDREN B
         WHERE A.CELL_PHONE = B.PARENT_CELL_PHONE
           <if test="qrCode != null and qrCode != ''">
           AND A.QR_CODE = #{qrCode}
           </if>
           <if test="name != null and name != ''">
           AND A.NAME = #{name}
           </if>
           <if test="childName != null and childName != ''">
           AND B.NAME = #{childName}
           </if>
           <if test="cellPhone != null and cellPhone != ''">
           AND A.CELL_PHONE = #{cellPhone}
           </if>
    </select>
	
	<select id="selectChildMemberList" parameterType="kr.co.crevill.member.MemberDto" resultType="kr.co.crevill.member.MemberVo">
    	SELECT A.NAME,
		       A.CELL_PHONE,
		       A.EMAIL,
		       A.ADDRESS,
		       A.QR_CODE,
		       A.PASSWORD,
		       A.STORE_ID,
		       (SELECT S.STORE_NAME FROM STORE S WHERE A.STORE_ID = S.STORE_ID) STORE_NAME,
		       B.NAME CHILD_NAME,
		       B.ENG_NAME
		  FROM MEMBER_PARENT A,
		       MEMBER_CHILDREN B
		 WHERE A.CELL_PHONE = #{parentCellPhone} 
		   AND A.CELL_PHONE = B.PARENT_CELL_PHONE
    </select>
	
	<select id="selectVisitStoreList" parameterType="kr.co.crevill.member.MemberDto" resultType="kr.co.crevill.member.MemberVo">
		SELECT DATE_FORMAT(A.REG_DATE, '%Y-%m-%d') VISIT_DATE,
		       CASE WHEN B.STORE_ID = 'MOBILE' THEN '모바일'
		       	    ELSE (SELECT STORE_NAME FROM STORE S WHERE B.STORE_ID = S.STORE_ID)
		       	    END AS STORE_NAME,
		       D.TICKET_NAME,
		       CASE WHEN C.STATUS = '04' THEN CONCAT ('+', TRUNCATE((C.USE_TIME / 60),0))
		            ELSE CONCAT ('-', TRUNCATE((C.USE_TIME / 60),0)) END AS USE_TIME,
		       E.NAME PLAY_NAME     
		  FROM SCHEDULE_ENTRANCE_MEMBER A,
		       SCHEDULE B,
		       VOUCHER_USE C,
		       VOUCHER D,
		       PLAY E,
		       RESERVATION R
		 WHERE A.MEMBER_QR_CODE = #{qrCode} 
		   AND A.SCHEDULE_ID = B.SCHEDULE_ID
		   AND R.SCHEDULE_ID = B.SCHEDULE_ID
		   AND C.RESERVATION_ID = R.RESERVATION_ID
		   AND C.VOUCHER_NO = D.VOUCHER_NO 
		   AND B.PLAY_ID = E.PLAY_ID
	</select>
	
	<select id="selectVisitStoreSummary" parameterType="kr.co.crevill.member.MemberDto" resultType="kr.co.crevill.member.MemberVo">
		SELECT DATE_FORMAT(A.REG_DATE, '%Y-%m-%d') VISIT_DATE,
		       CASE WHEN B.STORE_ID = 'MOBILE' THEN '모바일'
		       	    ELSE (SELECT STORE_NAME FROM STORE S WHERE B.STORE_ID = S.STORE_ID)
		       	    END AS STORE_NAME     
		  FROM SCHEDULE_ENTRANCE_MEMBER A,
		       SCHEDULE B
		 WHERE A.MEMBER_QR_CODE = #{qrCode}
		   AND A.SCHEDULE_ID = B.SCHEDULE_ID
	  ORDER BY A.REG_DATE DESC
	     LIMIT 1 	   
	</select>
	
	<insert id="insertMemberParent" parameterType="kr.co.crevill.member.MemberDto">
    	INSERT INTO MEMBER_PARENT (
    								NAME,
    								CELL_PHONE,
    								EMAIL,
    								ADDRESS,
    								QR_CODE,
									REG_DATE,
									REG_ID,
									STORE_ID,
									PASSWORD,
									BIRTHDAY,
									SEX,
									MOBILE_CORP,
									DI    								
    							   )
							VALUES (
									#{parentName},
									#{cellPhone},
									#{email},
									#{address},
									QR_SEQ_NEXTVAL(),
									NOW(),
									#{regId},
									#{storeId},
									#{password},
									#{parentBirthday},
									#{parentSex},
									#{mobileCorp},
									#{di}
								   )
    </insert>

	<insert id="insertMemberChildren" parameterType="kr.co.crevill.member.MemberDto">
    	INSERT INTO MEMBER_CHILDREN (
    								PARENT_NAME,
    								PARENT_CELL_PHONE,
    								NAME,
    								ENG_NAME,
    								BIRTHDAY,
    								SEX,
    								PICTURE_IDX,
    								REG_ID,
    								REG_DATE
    							   )
							VALUES (
									#{parentName},
									#{cellPhone},
									#{childName},
									#{engName},
									#{birthday},
									#{sex},
									#{pictureIdx},
									#{regId},
									NOW()
								   )
    </insert>
	
	<insert id="insertMemberChildrenGrade" parameterType="kr.co.crevill.member.MemberDto">
    	INSERT INTO MEMBER_CHILDREN_GRADE (
    								       PARENT_CELL_PHONE,
									       CHILDREN_NAME,
									       LEARNING_GRADE,
    								       REG_ID,
    								       REG_DATE
    							          )
								   VALUES (
										   #{cellPhone},
										   #{childName},
										   #{learningGrade},
										   #{regId},
										   NOW()
									      )
    </insert>
	
	<update id="updateMemberParent" parameterType="kr.co.crevill.member.MemberDto">
    	UPDATE MEMBER_PARENT 
    	  <set>
	       	  <if test="parentName != null">NAME = #{parentName},</if>
	       	  <if test="cellPhone != null">CELL_PHONE = #{cellPhone},</if>
	       	  <if test="email != null">EMAIL = #{email},</if>
	       	  <if test="address != null">ADDRESS = #{address},</if>
	       	  <if test="password != null">PASSWORD = #{password},</if>
	       	  UPD_ID = #{updId},
			  UPD_DATE = NOW()
       	  </set>
        WHERE CELL_PHONE = #{cellPhone} 
    </update>
	
	<update id="updateMemberChild" parameterType="kr.co.crevill.member.MemberDto">
    	UPDATE MEMBER_CHILDREN 
    	  <set>
    		  <if test="engName != null">ENG_NAME = #{engName},</if>
	       	  <if test="birthday != null">BIRTHDAY = #{birthday},</if>
	       	  <if test="sex != null">SEX = #{sex},</if>
	       	  <if test="pictureIdx != null">PICTURE_IDX = #{pictureIdx},</if>
	       	  UPD_ID = #{updId},
			  UPD_DATE = NOW()
       	  </set>
        WHERE PARENT_CELL_PHONE = #{cellPhone} 
          AND NAME = #{childName}
    </update>
	
	<delete id="deleteMemberParent">
		DELETE
		  FROM MEMBER_PARENT
		 WHERE QR_CODE = #{qrCode}  
	</delete>
	
	<delete id="deleteMemberChildren">
		DELETE 
		  FROM MEMBER_CHILDREN
		 WHERE PARENT_CELL_PHONE = #{cellPhone} 
	</delete>
	
	<delete id="deleteMemberChildrenGrade">
		DELETE 
		  FROM MEMBER_CHILDREN_GRADE
		 WHERE PARENT_CELL_PHONE = #{cellPhone}
		   <if test="childName != null">
		   AND CHILDREN_NAME = #{childName}
		   </if> 
	</delete>
	
</mapper>